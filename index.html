<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Testing Center Scheduler</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Libre+Baskerville:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --bg: #f5f2eb;
    --surface: #ffffff;
    --surface2: #faf8f4;
    --border: #ddd8ce;
    --text: #1a1a1a;
    --text-muted: #7a7570;
    --approved: #1a6b3c;
    --approved-bg: #e8f5ee;
    --approved-border: #a3d4b5;
    --pending: #7a4f00;
    --pending-bg: #fef6e4;
    --pending-border: #f0c97a;
    --new: #1a3d6b;
    --new-bg: #e4eef8;
    --new-border: #7aabd4;
    --accent: #c84b2f;
    --mono: 'DM Mono', monospace;
    --serif: 'Libre Baskerville', serif;
    --sans: 'DM Sans', sans-serif;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  /* HEADER */
  header {
    background: var(--text);
    color: white;
    padding: 20px 40px;
    display: flex;
    align-items: baseline;
    gap: 20px;
    border-bottom: 3px solid var(--accent);
  }
  header h1 {
    font-family: var(--serif);
    font-size: 1.5rem;
    font-weight: 700;
    letter-spacing: -0.02em;
  }
  header span {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: #888;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  /* MAIN LAYOUT */
  main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 32px 40px;
  }

  /* TOP CONTROLS */
  .controls {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
    margin-bottom: 28px;
  }

  /* DROP ZONES */
  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: 8px;
    padding: 28px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    background: var(--surface);
    position: relative;
  }
  .drop-zone:hover, .drop-zone.drag-over {
    border-color: var(--accent);
    background: #fdf5f3;
  }
  .drop-zone.loaded-approved {
    border-color: var(--approved-border);
    background: var(--approved-bg);
    border-style: solid;
  }
  .drop-zone.loaded-pending {
    border-color: var(--pending-border);
    background: var(--pending-bg);
    border-style: solid;
  }
  .drop-zone-icon {
    font-size: 2rem;
    margin-bottom: 8px;
    display: block;
  }
  .drop-zone-label {
    font-family: var(--mono);
    font-size: 0.65rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 6px;
  }
  .drop-zone-name {
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--text);
  }
  .drop-zone input[type="file"] {
    position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%;
  }
  .drop-zone .count-badge {
    margin-top: 8px;
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--text-muted);
  }

  /* ACTIONS PANEL */
  .actions-panel {
    display: flex;
    flex-direction: column;
    gap: 10px;
    justify-content: center;
  }
  .btn {
    font-family: var(--sans);
    font-size: 0.85rem;
    font-weight: 600;
    padding: 10px 18px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
    letter-spacing: 0.01em;
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
  }
  .btn-primary {
    background: var(--text);
    color: white;
  }
  .btn-primary:hover { background: #333; }
  .btn-primary:disabled { background: #aaa; cursor: not-allowed; }
  .btn-export {
    background: var(--approved);
    color: white;
  }
  .btn-export:hover { background: #145530; }
  .btn-export:disabled { background: #aaa; cursor: not-allowed; }
  .btn-clear {
    background: transparent;
    color: var(--text-muted);
    border: 1px solid var(--border);
    font-size: 0.78rem;
  }
  .btn-clear:hover { background: var(--surface2); color: var(--text); }

  /* FILTER BAR */
  .filter-bar {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  .filter-bar label {
    font-family: var(--mono);
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
  }
  .filter-btn {
    font-family: var(--mono);
    font-size: 0.68rem;
    letter-spacing: 0.06em;
    padding: 5px 12px;
    border-radius: 20px;
    border: 1.5px solid var(--border);
    background: transparent;
    cursor: pointer;
    transition: all 0.15s;
    color: var(--text-muted);
  }
  .filter-btn.active-all { border-color: var(--text); color: var(--text); background: var(--surface); font-weight: 500; }
  .filter-btn.active-approved { border-color: var(--approved); color: var(--approved); background: var(--approved-bg); font-weight: 500; }
  .filter-btn.active-pending { border-color: var(--pending); color: var(--pending); background: var(--pending-bg); font-weight: 500; }
  .filter-btn.active-new { border-color: var(--new); color: var(--new); background: var(--new-bg); font-weight: 500; }

  .search-box {
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .search-box input {
    font-family: var(--sans);
    font-size: 0.82rem;
    padding: 6px 12px;
    border: 1.5px solid var(--border);
    border-radius: 6px;
    background: var(--surface);
    width: 200px;
    outline: none;
  }
  .search-box input:focus { border-color: var(--accent); }

  /* DATE GROUP */
  .date-group {
    margin-bottom: 28px;
  }
  .date-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 10px;
    padding-bottom: 8px;
    border-bottom: 1.5px solid var(--border);
  }
  .date-header h2 {
    font-family: var(--serif);
    font-size: 1.05rem;
    font-weight: 700;
  }
  .date-header .date-stats {
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--text-muted);
    letter-spacing: 0.08em;
  }

  /* TABLE */
  .table-wrap {
    overflow-x: auto;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--surface);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.82rem;
  }
  thead th {
    background: var(--surface2);
    font-family: var(--mono);
    font-size: 0.62rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
    padding: 10px 14px;
    text-align: left;
    border-bottom: 1.5px solid var(--border);
    white-space: nowrap;
  }
  tbody tr {
    border-bottom: 1px solid #f0ece5;
    transition: background 0.1s;
  }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: var(--surface2); }
  td {
    padding: 9px 14px;
    vertical-align: middle;
    white-space: nowrap;
  }
  td.student-name { font-weight: 600; }

  /* STATUS BADGES */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    padding: 3px 9px;
    border-radius: 20px;
    font-family: var(--mono);
    font-size: 0.6rem;
    letter-spacing: 0.08em;
    font-weight: 500;
    white-space: nowrap;
  }
  .badge-approved { background: var(--approved-bg); color: var(--approved); border: 1px solid var(--approved-border); }
  .badge-pending { background: var(--pending-bg); color: var(--pending); border: 1px solid var(--pending-border); }
  .badge-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
  .badge-approved .badge-dot { background: var(--approved); }
  .badge-pending .badge-dot { background: var(--pending); }

  /* NEW MARKER */
  .new-row td:first-child {
    border-left: 3px solid var(--new);
  }
  .new-tag {
    display: inline-block;
    background: var(--new-bg);
    color: var(--new);
    border: 1px solid var(--new-border);
    border-radius: 4px;
    font-family: var(--mono);
    font-size: 0.55rem;
    letter-spacing: 0.1em;
    padding: 1px 5px;
    margin-left: 6px;
    vertical-align: middle;
    font-weight: 600;
    text-transform: uppercase;
  }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
  }
  .empty-state .icon { font-size: 3rem; margin-bottom: 16px; display: block; }
  .empty-state h3 { font-family: var(--serif); font-size: 1.2rem; margin-bottom: 8px; color: var(--text); }
  .empty-state p { font-size: 0.88rem; line-height: 1.6; }

  /* LEGEND */
  .legend {
    display: flex;
    gap: 20px;
    align-items: center;
    margin-left: auto;
    flex-wrap: wrap;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: var(--mono);
    font-size: 0.6rem;
    letter-spacing: 0.08em;
    color: var(--text-muted);
  }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--text);
    color: white;
    padding: 12px 18px;
    border-radius: 8px;
    font-size: 0.82rem;
    font-family: var(--sans);
    transform: translateY(80px);
    opacity: 0;
    transition: all 0.3s;
    z-index: 100;
    max-width: 320px;
  }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { border-left: 4px solid #2ecc71; }
  .toast.error { border-left: 4px solid var(--accent); }
  .toast.info { border-left: 4px solid #3498db; }

  /* SUMMARY STRIP */
  .summary-strip {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
    margin-bottom: 24px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px 18px;
  }
  .stat-card .stat-num {
    font-family: var(--serif);
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 4px;
  }
  .stat-card .stat-label {
    font-family: var(--mono);
    font-size: 0.6rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--text-muted);
  }
  .stat-card.s-approved .stat-num { color: var(--approved); }
  .stat-card.s-pending .stat-num { color: var(--pending); }
  .stat-card.s-new .stat-num { color: var(--new); }

  /* ACCOMMODATIONS TOOLTIP */
  td .accom-short {
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: block;
    color: var(--text-muted);
    font-size: 0.75rem;
    cursor: help;
  }

  @media (max-width: 900px) {
    main { padding: 20px; }
    .controls { grid-template-columns: 1fr; }
    .summary-strip { grid-template-columns: 1fr 1fr; }
    header { padding: 16px 20px; }
  }
</style>
</head>
<body>

<header>
  <h1>Testing Center Scheduler</h1>
  <span>Finals 2026 ¬∑ Spring</span>
</header>

<main>
  <!-- DROP ZONES -->
  <div class="controls">
    <div class="drop-zone" id="drop-approved" ondragover="handleDragOver(event,'approved')" ondragleave="handleDragLeave(event,'approved')" ondrop="handleDrop(event,'approved')">
      <input type="file" accept=".xlsx,.xls" onchange="handleFileInput(event,'approved')">
      <span class="drop-zone-icon">‚úÖ</span>
      <div class="drop-zone-label">Approved File</div>
      <div class="drop-zone-name" id="approved-filename">Drop or click to upload</div>
      <div class="count-badge" id="approved-count"></div>
    </div>

    <div class="drop-zone" id="drop-pending" ondragover="handleDragOver(event,'pending')" ondragleave="handleDragLeave(event,'pending')" ondrop="handleDrop(event,'pending')">
      <input type="file" accept=".xlsx,.xls" onchange="handleFileInput(event,'pending')">
      <span class="drop-zone-icon">üïê</span>
      <div class="drop-zone-label">Pending File</div>
      <div class="drop-zone-name" id="pending-filename">Drop or click to upload</div>
      <div class="count-badge" id="pending-count"></div>
    </div>

    <div class="actions-panel">
      <button class="btn btn-primary" id="btn-process" onclick="processFiles()" disabled>
        ‚ö° Process & Compare
      </button>
      <button class="btn btn-export" id="btn-export" onclick="exportToExcel()" disabled>
        üì• Export to Excel
      </button>
      <button class="btn btn-clear" onclick="clearAll()">
        üóë Clear & Reset
      </button>
    </div>
  </div>

  <!-- SUMMARY -->
  <div class="summary-strip" id="summary-strip" style="display:none">
    <div class="stat-card">
      <div class="stat-num" id="stat-total">0</div>
      <div class="stat-label">Total Students</div>
    </div>
    <div class="stat-card s-approved">
      <div class="stat-num" id="stat-approved">0</div>
      <div class="stat-label">Approved</div>
    </div>
    <div class="stat-card s-pending">
      <div class="stat-num" id="stat-pending">0</div>
      <div class="stat-label">Pending</div>
    </div>
    <div class="stat-card s-new">
      <div class="stat-num" id="stat-new">0</div>
      <div class="stat-label">New Since Last Load</div>
    </div>
  </div>

  <!-- FILTER BAR -->
  <div class="filter-bar" id="filter-bar" style="display:none">
    <label>Show:</label>
    <button class="filter-btn active-all" onclick="setFilter('all', this)">All</button>
    <button class="filter-btn" onclick="setFilter('approved', this)">‚úÖ Approved</button>
    <button class="filter-btn" onclick="setFilter('pending', this)">üïê Pending</button>
    <button class="filter-btn" onclick="setFilter('new', this)">üÜï New</button>
    <div class="search-box">
      <input type="text" id="search-input" placeholder="Search students..." oninput="renderTable()">
    </div>
  </div>

  <!-- TABLE / EMPTY STATE -->
  <div id="content-area">
    <div class="empty-state">
      <span class="icon">üìã</span>
      <h3>No files loaded yet</h3>
      <p>Upload your Approved and/or Pending files above.<br>The app will track who is new vs. already scheduled each time you reload.</p>
    </div>
  </div>
</main>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let approvedData = [];
let pendingData  = [];
let allRows      = [];
let currentFilter = 'all';
// Persistent memory using localStorage
let previousKeys = JSON.parse(localStorage.getItem('scheduler_known_keys') || '[]');

// ‚îÄ‚îÄ‚îÄ FILE HANDLING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleDragOver(e, type) {
  e.preventDefault();
  document.getElementById('drop-' + type).classList.add('drag-over');
}
function handleDragLeave(e, type) {
  document.getElementById('drop-' + type).classList.remove('drag-over');
}
function handleDrop(e, type) {
  e.preventDefault();
  handleDragLeave(e, type);
  const file = e.dataTransfer.files[0];
  if (file) loadFile(file, type);
}
function handleFileInput(e, type) {
  const file = e.target.files[0];
  if (file) loadFile(file, type);
}

function loadFile(file, type) {
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array', cellDates: true });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
      const parsed = parseReport(json, type);
      if (type === 'approved') {
        approvedData = parsed;
        document.getElementById('approved-filename').textContent = file.name;
        document.getElementById('approved-count').textContent = parsed.length + ' students';
        document.getElementById('drop-approved').classList.add('loaded-approved');
      } else {
        pendingData = parsed;
        document.getElementById('pending-filename').textContent = file.name;
        document.getElementById('pending-count').textContent = parsed.length + ' students';
        document.getElementById('drop-pending').classList.add('loaded-pending');
      }
      updateProcessButton();
      showToast(file.name + ' loaded ‚Äî ' + parsed.length + ' records', 'success');
    } catch(err) {
      showToast('Error reading file: ' + err.message, 'error');
    }
  };
  reader.readAsArrayBuffer(file);
}

function parseReport(rows, type) {
  if (!rows || rows.length < 2) return [];
  const header = rows[0];
  const colIdx = {};
  header.forEach((h, i) => { if (h) colIdx[String(h).trim()] = i; });

  const results = [];
  for (let r = 1; r < rows.length; r++) {
    const row = rows[r];
    const student = getCellStr(row, colIdx, 'Student');
    if (!student) continue;
    const dateRaw = row[colIdx['Testing Date']];
    let dateStr = '';
    if (dateRaw instanceof Date) {
      dateStr = dateRaw.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric', year:'numeric' });
    } else if (dateRaw) {
      dateStr = String(dateRaw);
    }
    results.push({
      type,
      student,
      room: getCellStr(row, colIdx, 'Testing Room'),
      slot: getCellStr(row, colIdx, 'Testing Room Slot'),
      date: dateStr,
      dateRaw: dateRaw,
      time: getCellStr(row, colIdx, 'Testing Time'),
      endTime: getCellStr(row, colIdx, 'End Time'),
      testLength: getCellStr(row, colIdx, 'Test Length'),
      course: getCellStr(row, colIdx, 'Course'),
      accommodations: getCellStr(row, colIdx, 'Accommodations'),
      key: student + '|' + dateStr + '|' + type
    });
  }
  return results;
}

function getCellStr(row, colIdx, col) {
  const idx = colIdx[col];
  if (idx === undefined || row[idx] === null || row[idx] === undefined) return '';
  return String(row[idx]).trim();
}

function updateProcessButton() {
  const btn = document.getElementById('btn-process');
  btn.disabled = (approvedData.length === 0 && pendingData.length === 0);
}

// ‚îÄ‚îÄ‚îÄ PROCESS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function processFiles() {
  allRows = [...approvedData, ...pendingData];
  allRows.sort((a, b) => {
    const da = a.dateRaw instanceof Date ? a.dateRaw : new Date(a.date);
    const db = b.dateRaw instanceof Date ? b.dateRaw : new Date(b.date);
    if (da < db) return -1;
    if (da > db) return 1;
    return a.student.localeCompare(b.student);
  });

  // Tag new rows
  const currentKeys = allRows.map(r => r.key);
  allRows.forEach(r => {
    r.isNew = !previousKeys.includes(r.key);
  });

  // Save new set of known keys
  const merged = [...new Set([...previousKeys, ...currentKeys])];
  localStorage.setItem('scheduler_known_keys', JSON.stringify(merged));
  previousKeys = merged;

  // Stats
  const total = allRows.length;
  const nApproved = allRows.filter(r => r.type === 'approved').length;
  const nPending  = allRows.filter(r => r.type === 'pending').length;
  const nNew      = allRows.filter(r => r.isNew).length;

  document.getElementById('stat-total').textContent    = total;
  document.getElementById('stat-approved').textContent = nApproved;
  document.getElementById('stat-pending').textContent  = nPending;
  document.getElementById('stat-new').textContent      = nNew;
  document.getElementById('summary-strip').style.display = 'grid';
  document.getElementById('filter-bar').style.display    = 'flex';
  document.getElementById('btn-export').disabled = false;

  currentFilter = 'all';
  document.querySelectorAll('.filter-btn').forEach(b => b.className = 'filter-btn');
  document.querySelector('.filter-btn').classList.add('active-all');
  document.getElementById('search-input').value = '';

  renderTable();
  showToast('Processed ' + total + ' students ¬∑ ' + nNew + ' new since last load', 'info');
}

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setFilter(f, btn) {
  currentFilter = f;
  document.querySelectorAll('.filter-btn').forEach(b => b.className = 'filter-btn');
  btn.classList.add('active-' + f);
  renderTable();
}

function renderTable() {
  const search = (document.getElementById('search-input')?.value || '').toLowerCase();

  let rows = allRows.filter(r => {
    if (currentFilter === 'approved' && r.type !== 'approved') return false;
    if (currentFilter === 'pending' && r.type !== 'pending') return false;
    if (currentFilter === 'new' && !r.isNew) return false;
    if (search && !r.student.toLowerCase().includes(search) && !r.course.toLowerCase().includes(search)) return false;
    return true;
  });

  if (rows.length === 0) {
    document.getElementById('content-area').innerHTML = `
      <div class="empty-state">
        <span class="icon">üîç</span>
        <h3>No results</h3>
        <p>Try adjusting your filter or search term.</p>
      </div>`;
    return;
  }

  // Group by date
  const groups = {};
  rows.forEach(r => {
    const d = r.date || 'Unknown Date';
    if (!groups[d]) groups[d] = [];
    groups[d].push(r);
  });

  let html = '';
  for (const [date, dateRows] of Object.entries(groups)) {
    const nNew = dateRows.filter(r => r.isNew).length;
    const nA   = dateRows.filter(r => r.type === 'approved').length;
    const nP   = dateRows.filter(r => r.type === 'pending').length;
    html += `
    <div class="date-group">
      <div class="date-header">
        <h2>${date}</h2>
        <div class="date-stats">${dateRows.length} students ¬∑ ${nA} approved ¬∑ ${nP} pending${nNew > 0 ? ' ¬∑ <span style="color:var(--new)">' + nNew + ' new</span>' : ''}</div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Student</th>
              <th>Status</th>
              <th>Time</th>
              <th>End</th>
              <th>Room</th>
              <th>Slot</th>
              <th>Length (min)</th>
              <th>Course</th>
              <th>Accommodations</th>
            </tr>
          </thead>
          <tbody>
    `;
    dateRows.forEach(r => {
      const newTag = r.isNew ? '<span class="new-tag">New</span>' : '';
      const badge  = r.type === 'approved'
        ? '<span class="badge badge-approved"><span class="badge-dot"></span>Approved</span>'
        : '<span class="badge badge-pending"><span class="badge-dot"></span>Pending</span>';
      const accom = r.accommodations
        ? `<span class="accom-short" title="${escHtml(r.accommodations)}">${escHtml(r.accommodations)}</span>`
        : '<span style="color:var(--text-muted);font-size:0.75rem">‚Äî</span>';
      html += `
        <tr class="${r.isNew ? 'new-row' : ''}">
          <td class="student-name">${escHtml(r.student)}${newTag}</td>
          <td>${badge}</td>
          <td>${escHtml(r.time)}</td>
          <td>${escHtml(r.endTime)}</td>
          <td style="font-family:var(--mono);font-size:0.75rem">${escHtml(r.room.replace('FINALS Smith Library ', ''))}</td>
          <td style="font-family:var(--mono);font-size:0.75rem">${escHtml(r.slot)}</td>
          <td style="font-family:var(--mono);font-size:0.75rem">${escHtml(r.testLength)}</td>
          <td style="max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;font-size:0.78rem" title="${escHtml(r.course)}">${escHtml(shortCourse(r.course))}</td>
          <td>${accom}</td>
        </tr>`;
    });
    html += '</tbody></table></div></div>';
  }

  document.getElementById('content-area').innerHTML = html;
}

function shortCourse(c) {
  if (!c) return '';
  // Extract just the course code and short name
  const m = c.match(/^([^(]+)/);
  return m ? m[1].trim() : c;
}

function escHtml(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚îÄ‚îÄ‚îÄ EXPORT: Self-contained framework grid with real color fills ‚îÄ
// Built as raw OOXML (ZIP of XML) ‚Äî no server needed, colors work natively.

const THIRD_FLOOR = {
  'slot-1':{col:2,name:'Room 1 ADA'},'slot-2':{col:3,name:'Room 2 WCA'},'slot-3':{col:4,name:'Room 3'},
  'slot-4':{col:5,name:'Room 4'},'slot-5':{col:6,name:'Room 5'},'slot-6':{col:7,name:'Room 6'},
  'slot-7':{col:8,name:'Room 7'},'slot-8':{col:9,name:'Room 8'},'slot-9':{col:10,name:'Room 9 WCA'},
  'slot-10':{col:11,name:'Room 10 ADA'},'slot-11':{col:12,name:'Room 11 WCA'},'slot-12':{col:13,name:'Room 12'},
  'slot-13':{col:14,name:'Room 13'},'slot-14':{col:15,name:'Room 14'},'slot-15':{col:16,name:'Room 15'},
  'slot-16':{col:17,name:'Room 16'},'slot-17':{col:18,name:'Room 17'},'slot-18':{col:19,name:'Room 18 WCA'},
};
const FOURTH_FLOOR = {
  'slot-2':{col:21,name:'4th Room 2'},'slot-3':{col:22,name:'4th Room 3'},'slot-4':{col:23,name:'4th Room 4'},
  'slot-5':{col:24,name:'4th Room 5'},'slot-6':{col:25,name:'4th Room 6'},'slot-7':{col:26,name:'4th Room 7'},
  'slot-8':{col:27,name:'4th Room 8'},'slot-9':{col:28,name:'4th Room 9'},'slot-10':{col:29,name:'4th Room 10'},
  'slot-11':{col:30,name:'4th Room 11'},'slot-12':{col:31,name:'4th Room 12'},'slot-13':{col:32,name:'4th Room 13'},
};
// Row 1 = header, rows 2-53 = schedule grid. 8am = row 2, each hour = 4 rows.
const H2R = {8:2,9:6,10:10,11:14,12:18,13:22,14:26,15:30,16:34,17:38,18:42,19:46,20:50};
const GSTART=2, GEND=53;

function parseMins(t) {
  const m=(t||'').trim().match(/(\d+)(?::(\d+))?\s*(am|pm)/i);
  if(!m)return null;
  let h=+m[1],mn=+(m[2]||0),p=m[3].toLowerCase();
  if(p==='pm'&&h!==12)h+=12; if(p==='am'&&h===12)h=0;
  return h*60+mn;
}
function minsToRow(mins) {
  if(mins===null)return GSTART;
  const h=Math.floor(mins/60),fr=(mins%60)/60;
  const keys=Object.keys(H2R).map(Number);
  const best=keys.reduce((a,b)=>Math.abs(b-h)<Math.abs(a-h)?b:a,8);
  return Math.min(H2R[best]+Math.round(fr*4),GEND);
}
function fmtTimeRange(s,e) {
  function sh(t){const m=(t||'').trim().match(/(\d+)(?::(\d+))?\s*(am|pm)/i);if(!m)return t||'';let h=+m[1],mn=m[2]||'00',p=m[3].toLowerCase();if(p==='pm'&&h!==12)h+=12;if(p==='am'&&h===12)h=0;const d=h<=12?h:h-12;return mn==='00'?String(d):`${d}:${mn}`;}
  const a=sh(s),b=sh(e); return a&&b?`${a}-${b}`:(a||b);
}
function colLetter(n) {
  const a=['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z','AA','AB','AC','AD','AE','AF','AG'];
  return a[n-1]||'A';
}
function xesc(s){return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

// Style indices ‚Äî match cellXfs in STYLES_XML:
// 0=default 1=hdr3 2=hdr4 3=timeCol 4=sep 5=empty3 6=empty4
// 7=approved-name 8=approved-time 9=approved-block
// 10=pending-name 11=pending-time 12=pending-block
// 13=newApr-name  14=newApr-time  15=newApr-block
// 16=newPnd-name  17=newPnd-time  18=newPnd-block
// 19=total-dark 20=total-apr 21=total-pnd 22=total-new
function getStyleSet(type,isNew) {
  if(type==='approved'&&!isNew)return{n:7,t:8,b:9};
  if(type==='pending' &&!isNew)return{n:10,t:11,b:12};
  if(type==='approved'&& isNew)return{n:13,t:14,b:15};
  return{n:16,t:17,b:18};
}

const STYLES_XML=`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">
<fonts count="10">
<font><sz val="9"/><name val="Arial"/></font>
<font><sz val="9"/><b/><color rgb="FF1F3864"/><name val="Arial"/></font>
<font><sz val="9"/><b/><color rgb="FF7F3F00"/><name val="Arial"/></font>
<font><sz val="9"/><b/><color rgb="FFFFFFFF"/><name val="Arial"/></font>
<font><sz val="9"/><color rgb="FF000000"/><name val="Arial"/></font>
<font><sz val="8"/><color rgb="FF595959"/><name val="Arial"/></font>
<font><sz val="9"/><b/><color rgb="FF1F3864"/><name val="Arial"/></font>
<font><sz val="9"/><b/><color rgb="FFFFFFFF"/><name val="Arial"/></font>
<font><sz val="9"/><b/><color rgb="FF375623"/><name val="Arial"/></font>
<font><sz val="9"/><b/><color rgb="FF7F6000"/><name val="Arial"/></font>
</fonts>
<fills count="14">
<fill><patternFill patternType="none"/></fill>
<fill><patternFill patternType="gray125"/></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FFBDD7EE"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FFFCE4D6"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FF2F5496"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FFD9D9D9"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FFEBF3FB"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FFFDF2EC"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FFC6EFCE"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FFFFEB9C"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FF92D050"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FFFFC000"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FF1F3864"/></patternFill></fill>
<fill><patternFill patternType="solid"><fgColor rgb="FF375623"/></patternFill></fill>
</fills>
<borders count="3">
<border><left/><right/><top/><bottom/></border>
<border><left style="thin"><color rgb="FFBFBFBF"/></left><right style="thin"><color rgb="FFBFBFBF"/></right><top style="thin"><color rgb="FFBFBFBF"/></top><bottom style="thin"><color rgb="FFBFBFBF"/></bottom></border>
<border><left style="hair"><color rgb="FFD9D9D9"/></left><right style="hair"><color rgb="FFD9D9D9"/></right><top style="hair"><color rgb="FFD9D9D9"/></top><bottom style="hair"><color rgb="FFD9D9D9"/></bottom></border>
</borders>
<cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs>
<cellXfs count="23">
<xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0"/>
<xf numFmtId="0" fontId="1" fillId="2" borderId="1" xfId="0"><alignment horizontal="center" vertical="center" wrapText="1"/></xf>
<xf numFmtId="0" fontId="2" fillId="3" borderId="1" xfId="0"><alignment horizontal="center" vertical="center" wrapText="1"/></xf>
<xf numFmtId="0" fontId="3" fillId="4" borderId="1" xfId="0"><alignment horizontal="center" vertical="center"/></xf>
<xf numFmtId="0" fontId="0" fillId="5" borderId="0" xfId="0"/>
<xf numFmtId="0" fontId="0" fillId="6" borderId="2" xfId="0"/>
<xf numFmtId="0" fontId="0" fillId="7" borderId="2" xfId="0"/>
<xf numFmtId="0" fontId="4" fillId="8" borderId="1" xfId="0"><alignment horizontal="left" vertical="top" wrapText="1"/></xf>
<xf numFmtId="0" fontId="5" fillId="8" borderId="1" xfId="0"><alignment horizontal="left" vertical="top"/></xf>
<xf numFmtId="0" fontId="0" fillId="8" borderId="1" xfId="0"/>
<xf numFmtId="0" fontId="4" fillId="9" borderId="1" xfId="0"><alignment horizontal="left" vertical="top" wrapText="1"/></xf>
<xf numFmtId="0" fontId="5" fillId="9" borderId="1" xfId="0"><alignment horizontal="left" vertical="top"/></xf>
<xf numFmtId="0" fontId="0" fillId="9" borderId="1" xfId="0"/>
<xf numFmtId="0" fontId="6" fillId="10" borderId="1" xfId="0"><alignment horizontal="left" vertical="top" wrapText="1"/></xf>
<xf numFmtId="0" fontId="5" fillId="10" borderId="1" xfId="0"><alignment horizontal="left" vertical="top"/></xf>
<xf numFmtId="0" fontId="0" fillId="10" borderId="1" xfId="0"/>
<xf numFmtId="0" fontId="6" fillId="11" borderId="1" xfId="0"><alignment horizontal="left" vertical="top" wrapText="1"/></xf>
<xf numFmtId="0" fontId="5" fillId="11" borderId="1" xfId="0"><alignment horizontal="left" vertical="top"/></xf>
<xf numFmtId="0" fontId="0" fillId="11" borderId="1" xfId="0"/>
<xf numFmtId="0" fontId="7" fillId="12" borderId="1" xfId="0"><alignment horizontal="center" vertical="center"/></xf>
<xf numFmtId="0" fontId="8" fillId="8"  borderId="1" xfId="0"><alignment horizontal="center" vertical="center"/></xf>
<xf numFmtId="0" fontId="9" fillId="9"  borderId="1" xfId="0"><alignment horizontal="center" vertical="center"/></xf>
<xf numFmtId="0" fontId="7" fillId="10" borderId="1" xfId="0"><alignment horizontal="center" vertical="center"/></xf>
</cellXfs>
</styleSheet>`;

function exportToExcel() {
  if (!allRows.length) return;

  const byDate = {};
  allRows.forEach(r => { if(!byDate[r.date])byDate[r.date]=[]; byDate[r.date].push(r); });
  const sortedDates = Object.keys(byDate).sort((a,b) => new Date(a)-new Date(b));

  const sheetNames=[], sheetXMLs=[], ss=[], ssMap={};
  function si(v) { const s=String(v||''); if(s in ssMap)return ssMap[s]; const i=ss.length; ssMap[s]=i; ss.push(s); return i; }

  const timeLbls = {2:'8:00',6:'9:00',10:'10:00',14:'11:00',18:'12:00',22:'1:00',26:'2:00',30:'3:00',34:'4:00',38:'5:00',42:'6:00',46:'7:00',50:'8:00'};

  sortedDates.forEach(dateStr => {
    const day = byDate[dateStr];
    let sn = dateStr;
    try { const d=new Date(dateStr); sn=`${d.getMonth()+1}-${d.getDate()}-${String(d.getFullYear()).slice(2)}`; } catch(e){}
    sheetNames.push(sn.slice(0,31));

    // Sparse cell grid: grid[row][col] = {v, s}  (1-indexed)
    const grid = {};
    function sc(r,c,v,s) { if(!grid[r])grid[r]={}; grid[r][c]={v:(v===null||v===undefined)?'':v, s}; }

    // Row 1: headers
    sc(1,1,dateStr,1);
    Object.values(THIRD_FLOOR).forEach(({col,name}) => sc(1,col,name,1));
    sc(1,20,'',4);
    Object.values(FOURTH_FLOOR).forEach(({col,name}) => sc(1,col,name,2));

    // Rows 2-53: background grid
    for(let r=GSTART;r<=GEND;r++) {
      const lbl=timeLbls[r];
      sc(r,1,lbl||'',lbl?3:0);
      for(let c=2;c<20;c++) sc(r,c,'',5);
      sc(r,20,'',4);
      for(let c=21;c<33;c++) sc(r,c,'',6);
    }

    // Place students ‚Äî color spans full time block
    [...day].sort((a,b)=>(parseMins(a.time)||0)-(parseMins(b.time)||0)).forEach(rec => {
      const slot = (rec.slot||'').toLowerCase().trim();
      const is4 = (rec.room||'').toLowerCase().includes('4th');
      const mp = (is4?FOURTH_FLOOR:THIRD_FLOOR)[slot] || THIRD_FLOOR[slot] || FOURTH_FLOOR[slot];
      if(!mp) return;
      const col = mp.col;
      const sm = parseMins(rec.time), em = parseMins(rec.endTime);
      const sm2 = sm!==null?sm:480, em2 = em!==null?em:sm2+90;
      let sr = Math.max(minsToRow(sm2), GSTART);
      let er = Math.min(minsToRow(em2), GEND);
      if(er<=sr) er = Math.min(sr+3,GEND);
      const {n,t,b} = getStyleSet(rec.type, rec.isNew);
      // Fill entire span with block color
      for(let r=sr;r<=er;r++) sc(r,col,'',b);
      // Full name in one cell (row 1 of block)
      sc(sr, col, rec.student, n);
      // Time range on row 2 of block
      if(sr+1<=er) sc(sr+1, col, fmtTimeRange(rec.time, rec.endTime), t);
    });

    // Totals row 55
    const nT=day.length, nA=day.filter(r=>r.type==='approved').length;
    const nP=day.filter(r=>r.type==='pending').length, nN=day.filter(r=>r.isNew).length;
    sc(55,1,'TOTALS',19); sc(55,2,`TOTAL: ${nT}`,19);
    sc(55,4,`APPROVED: ${nA}`,20); sc(55,7,`PENDING: ${nP}`,21); sc(55,10,`NEW: ${nN}`,22);
    // Legend row 56
    sc(56,2,'',9); sc(56,3,'Approved',0); sc(56,4,'',12); sc(56,5,'Pending',0);
    sc(56,6,'',15); sc(56,7,'New Approved',0); sc(56,8,'',18); sc(56,9,'New Pending',0);

    // Serialize to XML rows
    let rowsXml='';
    Object.keys(grid).sort((a,b)=>+a-+b).forEach(rn => {
      const ht = rn==='1' ? ' ht="22" customHeight="1"' : ' ht="15" customHeight="1"';
      rowsXml += `<row r="${rn}"${ht}>`;
      Object.keys(grid[rn]).sort((a,b)=>+a-+b).forEach(cn => {
        const {v,s} = grid[rn][cn];
        const addr = colLetter(+cn)+rn;
        if(v===''||v===null||v===undefined) { rowsXml+=`<c r="${addr}" s="${s}"/>`; }
        else { rowsXml+=`<c r="${addr}" s="${s}" t="s"><v>${si(v)}</v></c>`; }
      });
      rowsXml+='</row>';
    });

    sheetXMLs.push(`<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
<sheetViews><sheetView workbookViewId="0"><pane xSplit="1" ySplit="1" topLeftCell="B2" activePane="bottomRight" state="frozen"/></sheetView></sheetViews>
<cols><col min="1" max="1" width="6.5" customWidth="1"/><col min="2" max="19" width="15" customWidth="1"/><col min="20" max="20" width="1.5" customWidth="1"/><col min="21" max="32" width="15" customWidth="1"/></cols>
<sheetData>${rowsXml}</sheetData>
</worksheet>`);
  });

  // ‚îÄ‚îÄ TOTALS SUMMARY sheet (first tab) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Collect per-date totals from what we already built
  const totalsData = sortedDates.map(dateStr => {
    const day = byDate[dateStr];
    return {
      date: dateStr,
      total: day.length,
      approved: day.filter(r=>r.type==='approved').length,
      pending:  day.filter(r=>r.type==='pending').length,
      newCount: day.filter(r=>r.isNew).length,
    };
  });
  const gt = totalsData.reduce((a,r)=>a+r.total,0);
  const ga = totalsData.reduce((a,r)=>a+r.approved,0);
  const gp = totalsData.reduce((a,r)=>a+r.pending,0);
  const gn = totalsData.reduce((a,r)=>a+r.newCount,0);

  // Style indices for summary sheet reuse existing fills:
  // 19=navy(dark),  20=approved-green,  21=pending-yellow,  22=new-brightgreen
  // new style 23 = white bold header text on navy (same as 19 but text)
  let sumRowsXml = '';
  function sumCell(r,c,v,s) {
    const addr = colLetter(c)+r;
    if(v===''||v===null||v===undefined) return `<c r="${addr}" s="${s}"/>`;
    return `<c r="${addr}" s="${s}" t="s"><v>${si(v)}</v></c>`;
  }

  // Row 1: title
  sumRowsXml += `<row r="1" ht="28" customHeight="1">${sumCell(1,1,'TESTING CENTER ‚Äî FINALS SPRING 2026 ‚Äî TOTALS SUMMARY',19)}` +
    [2,3,4,5].map(c=>`<c r="${colLetter(c)}1" s="19"/>`).join('') + `</row>`;

  // Row 2: column headers
  sumRowsXml += `<row r="2" ht="20" customHeight="1">` +
    sumCell(2,1,'Date',19) + sumCell(2,2,'Total Students',19) +
    sumCell(2,3,'Approved',19) + sumCell(2,4,'Pending',19) + sumCell(2,5,'New',19) +
    `</row>`;

  // Data rows
  totalsData.forEach((d,i) => {
    const r = i+3;
    sumRowsXml += `<row r="${r}" ht="18" customHeight="1">` +
      sumCell(r,1,d.date,7) +                          // date ‚Äî approved-name style (readable)
      sumCell(r,2,String(d.total),19) +                 // total ‚Äî navy
      sumCell(r,3,String(d.approved),20) +              // approved ‚Äî green
      sumCell(r,4,String(d.pending),21) +               // pending ‚Äî yellow
      sumCell(r,5,String(d.newCount),22) +              // new ‚Äî bright green
      `</row>`;
  });

  // Grand total row
  const gr = totalsData.length+3;
  sumRowsXml += `<row r="${gr}" ht="22" customHeight="1">` +
    sumCell(gr,1,'GRAND TOTAL',19) + sumCell(gr,2,String(gt),19) +
    sumCell(gr,3,String(ga),20) + sumCell(gr,4,String(gp),21) + sumCell(gr,5,String(gn),22) +
    `</row>`;

  const summarySheetXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships">
<cols><col min="1" max="1" width="18" customWidth="1"/><col min="2" max="2" width="16" customWidth="1"/><col min="3" max="3" width="14" customWidth="1"/><col min="4" max="4" width="14" customWidth="1"/><col min="5" max="5" width="12" customWidth="1"/></cols>
<sheetData>${sumRowsXml}</sheetData>
</worksheet>`;

  // All sheets: summary first, then date sheets
  const allSheetNames = ['TOTALS SUMMARY', ...sheetNames];
  const allSheetXMLs  = [summarySheetXml, ...sheetXMLs];

  const ssXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><sst xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" count="${ss.length}" uniqueCount="${ss.length}">${ss.map(s=>`<si><t xml:space="preserve">${xesc(s)}</t></si>`).join('')}</sst>`;
  const wbXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"><sheets>${allSheetNames.map((n,i)=>`<sheet name="${xesc(n)}" sheetId="${i+1}" r:id="rId${i+2}"/>`).join('')}</sheets></workbook>`;
  // rId1=styles, rId2..N+1=sheets, rId(N+2)=sharedStrings  ‚Äî all unique
  const ssRid = allSheetNames.length + 2;
  const wbRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/><Relationship Id="rId${ssRid}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/sharedStrings" Target="sharedStrings.xml"/>${allSheetNames.map((n,i)=>`<Relationship Id="rId${i+2}" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet${i+1}.xml"/>`).join('')}</Relationships>`;
  const ct = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/><Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.stylesheet+xml"/><Override PartName="/xl/sharedStrings.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sharedStrings+xml"/>${allSheetNames.map((n,i)=>`<Override PartName="/xl/worksheets/sheet${i+1}.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/>`).join('')}</Types>`;
  const rootRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/></Relationships>`;

  const files = {
    '[Content_Types].xml': ct, '_rels/.rels': rootRels,
    'xl/workbook.xml': wbXml, 'xl/_rels/workbook.xml.rels': wbRels,
    'xl/styles.xml': STYLES_XML, 'xl/sharedStrings.xml': ssXml,
  };
  allSheetNames.forEach((n,i) => { files[`xl/worksheets/sheet${i+1}.xml`] = allSheetXMLs[i]; });

  const blob = new Blob([buildZip(files)], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `Testing_Schedule_${new Date().toISOString().slice(0,10)}.xlsx`;
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('Excel exported with color blocks!', 'success');
}

function buildZip(files) {
  const enc = new TextEncoder();
  const parts = [], cd = [];
  let offset = 0;
  function crc32(d) {
    let c=0xFFFFFFFF;
    const t=new Uint32Array(256);
    for(let i=0;i<256;i++){let x=i;for(let j=0;j<8;j++)x=x&1?(0xEDB88320^(x>>>1)):(x>>>1);t[i]=x;}
    for(let i=0;i<d.length;i++)c=t[(c^d[i])&0xFF]^(c>>>8);
    return(c^0xFFFFFFFF)>>>0;
  }
  for(const[name,content]of Object.entries(files)){
    const nb=enc.encode(name), db=typeof content==='string'?enc.encode(content):content;
    const crc=crc32(db), local=new Uint8Array(30+nb.length+db.length), dv=new DataView(local.buffer);
    dv.setUint32(0,0x04034b50,true);dv.setUint16(4,20,true);dv.setUint16(6,0,true);dv.setUint16(8,0,true);
    dv.setUint16(10,0,true);dv.setUint16(12,0,true);dv.setUint32(14,crc,true);dv.setUint32(18,db.length,true);
    dv.setUint32(22,db.length,true);dv.setUint16(26,nb.length,true);dv.setUint16(28,0,true);
    local.set(nb,30); local.set(db,30+nb.length);
    const ce=new Uint8Array(46+nb.length), cv=new DataView(ce.buffer);
    cv.setUint32(0,0x02014b50,true);cv.setUint16(4,20,true);cv.setUint16(6,20,true);cv.setUint16(8,0,true);
    cv.setUint16(10,0,true);cv.setUint16(12,0,true);cv.setUint16(14,0,true);cv.setUint32(16,crc,true);
    cv.setUint32(20,db.length,true);cv.setUint32(24,db.length,true);cv.setUint16(28,nb.length,true);
    cv.setUint16(30,0,true);cv.setUint16(32,0,true);cv.setUint16(34,0,true);cv.setUint16(36,0,true);
    cv.setUint32(38,0,true);cv.setUint32(42,offset,true);ce.set(nb,46);
    parts.push(local); cd.push(ce); offset+=local.length;
  }
  const cdSize=cd.reduce((a,b)=>a+b.length,0), eocd=new Uint8Array(22), ev=new DataView(eocd.buffer);
  ev.setUint32(0,0x06054b50,true);ev.setUint16(4,0,true);ev.setUint16(6,0,true);
  ev.setUint16(8,cd.length,true);ev.setUint16(10,cd.length,true);
  ev.setUint32(12,cdSize,true);ev.setUint32(16,offset,true);ev.setUint16(20,0,true);
  const all=[...parts,...cd,eocd], total=all.reduce((a,b)=>a+b.length,0), out=new Uint8Array(total);
  let pos=0; all.forEach(p=>{out.set(p,pos);pos+=p.length;});
  return out;
}

// ‚îÄ‚îÄ‚îÄ UTILITIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function clearAll() {
  approvedData = [];
  pendingData  = [];
  allRows      = [];
  currentFilter = 'all';

  document.getElementById('approved-filename').textContent = 'Drop or click to upload';
  document.getElementById('pending-filename').textContent  = 'Drop or click to upload';
  document.getElementById('approved-count').textContent    = '';
  document.getElementById('pending-count').textContent     = '';
  document.getElementById('drop-approved').classList.remove('loaded-approved');
  document.getElementById('drop-pending').classList.remove('loaded-pending');
  document.getElementById('btn-process').disabled  = true;
  document.getElementById('btn-export').disabled   = true;
  document.getElementById('summary-strip').style.display = 'none';
  document.getElementById('filter-bar').style.display    = 'none';
  document.getElementById('content-area').innerHTML = `
    <div class="empty-state">
      <span class="icon">üìã</span>
      <h3>No files loaded yet</h3>
      <p>Upload your Approved and/or Pending files above.<br>The app will track who is new vs. already scheduled each time you reload.</p>
    </div>`;

  showToast('Cleared. Previous history still remembered.', 'info');
}

function showToast(msg, type='info') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + type + ' show';
  setTimeout(() => t.classList.remove('show'), 3500);
}

// Reset known history button (optional)
document.addEventListener('keydown', e => {
  if (e.ctrlKey && e.key === 'r' && e.shiftKey) {
    localStorage.removeItem('scheduler_known_keys');
    previousKeys = [];
    showToast('History reset ‚Äî all students will be "new" on next load', 'info');
    e.preventDefault();
  }
});
</script>
</body>
</html>
